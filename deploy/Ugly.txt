<!DOCTYPE html>
<html>
<head>
    <title>Milestones by Release</title>
    <!--  (c) 2017 CA Technologies.  All Rights Reserved. -->
    <!--  Build Date: Thu Jun 29 2017 06:14:16 GMT-0600 (MDT) -->
    
    <script type="text/javascript">
        var APP_BUILD_DATE = "Thu Jun 29 2017 06:14:16 GMT-0600 (MDT)";
        var STORY    = "F208";
        var BUILDER  = "corkr03";
        var CHECKSUM = 11961266718;
    </script>
    
    <script type="text/javascript" src="/apps/2.1/sdk.js"></script>
    <!-- our highcharts (needed so that we can add patterns) 
    <script type="text/javascript" src="/apps/2.1/lib/analytics/analytics-all.js"></script>
    -->
    
    
    <script type="text/javascript">
        Rally.onReady(function() {
            Ext.define("Rally.technicalservices.InfoLink",{extend:"Rally.ui.dialog.Dialog",alias:"widget.tsinfolink",informationHtml:null,title:"Build Information",defaults:{padding:5,margin:5},closable:!0,draggable:!0,autoShow:!0,width:350,informationalConfig:null,items:[{xtype:"container",itemId:"information"}],initComponent:function(){Ext.id(this);this.title="<span class='icon-help'> </span>"+this.title,this.callParent(arguments)},_generateChecksum:function(a){var b,c=305419896;for(a=a.replace(/var CHECKSUM = .*;/,""),a=a.replace(/var BUILDER  = .*;/,""),a=a.replace(/\s/g,""),b=0;b<a.length;b++)c+=a.charCodeAt(b)*b;return c},_checkChecksum:function(a){var b=Ext.create("Deft.Deferred"),c=this;return Ext.Ajax.request({url:document.URL,params:{id:1},success:function(a){if(text=a.responseText,CHECKSUM){var d=c._generateChecksum(text);if(CHECKSUM!==d)return void b.resolve(!1)}b.resolve(!0)}}),b.promise},_addToContainer:function(a){var b=Ext.apply({xtype:"container",height:200,overflowY:!0},this.informationalConfig);a.add(b)},afterRender:function(){var a=Rally.getApp();if(!Ext.isEmpty(this.informationalConfig)){var b=this.down("#information");this._addToContainer(b)}a.isExternal()?this.addDocked({xtype:"container",cls:"build-info",padding:2,dock:"bottom",html:"... Running externally"}):this._checkChecksum(a).then({scope:this,success:function(a){a||this.addDocked({xtype:"container",cls:"build-info",dock:"bottom",padding:2,html:'<span class="icon-warning"> </span>Checksums do not match'})},failure:function(a){console.log("oops:",a)}}),this.callParent(arguments)},beforeRender:function(){if(this.callParent(arguments),this.informationHtml&&this.addDocked({xtype:"component",componentCls:"intro-panel",padding:2,html:this.informationHtml,doc:"top"}),this.addDocked({xtype:"container",cls:"build-info",padding:2,dock:"bottom",html:"This app was created by the CA AC Technical Services Team."}),APP_BUILD_DATE){var a=Ext.String.format("Built on: {0} <br/>Built by: {1}",APP_BUILD_DATE,BUILDER);STORY&&(a=a+"<br/>Source story: "+STORY),this.addDocked({xtype:"container",cls:"build-info",padding:2,dock:"bottom",html:a})}}}),Ext.define("Rally.technicalservices.Logger",{constructor:function(a){Ext.apply(this,a)},log:function(a){var b="[ "+Ext.util.Format.date(new Date,"Y-m-d H:i:s.u")+" ]",c=[];c=Ext.Array.push(c,[b]),c=Ext.Array.push(c,Ext.Array.slice(arguments,0)),window.console&&console.log.apply(console,c)}}),Ext.define("cats-milestone-by-release.utils.MilestonesTemplate",{extend:"Ext.XTemplate",constructor:function(a){a=a||{};var b=['<tpl for=".">',"{[this.getPillHtml(values)]}","</tpl>",{getPillHtml:this.getPillHtml},a];return this.callParent(b)},getPillHtml:function(a){var b=a.DisplayColor?' style="color: '+a.DisplayColor+';"':"",c=this.iconCls?'<span class="'+this.iconCls+'"'+b+"></span>":"",d=a.TargetDate&&Rally.util.DateTime.formatWithDefault(Rally.util.DateTime.fromIsoString(a.TargetDate))||"",e=a.Name;return a.FormattedID&&(e=a.FormattedID+": "+a.Name),'<span class="'+(this.cls?this.cls:"")+'">'+c+e+"<br/><b>"+d+"</b></span>"},apply:function(a,b){var c=this._transformValues(a);return this.callParent([c,b])},_transformValues:function(a){var b=a[this.collectionName];return b=b._tagsNameArray?b._tagsNameArray?b._tagsNameArray:b:_.isArray(b)?_.map(b,function(a){var b=null;a.TargetDate&&(b=Rally.util.DateTime.fromIsoString(a.TargetDate));a.Name||a.get("Name");return{_ref:a._ref||a.get("_ref"),Name:a.Name||a.get("Name"),TargetDate:b,DisplayColor:a.DisplayColor,FormattedID:a.FormattedID}}):[],b=Rally.util.Array.sortByAttribute(b,"TargetDate")}}),Ext.define("cats-milestone-by-release.utils.PortfolioListTemplate",{extend:"Ext.XTemplate",constructor:function(a){a=a||{};var b=['<tpl for=".">','<div><span class="formatted-id-template">{[this.createIdValue(values)]}</span>: {[values.Name]}</div>',"</tpl>",a];return this.callParent(b)},createIdValue:function(a){return a.Recycled||this.renderIdAsText?this.createTextValue(a):this.createDetailLink(a)},createTextValue:function(a){return this.createIcon(a)+Ext.create("Rally.ui.renderer.template.StringTemplate",{fieldName:"FormattedID"}).apply(a)},createDetailLink:function(a){var b={record:a,text:this.createIcon(a)+(a.FormattedID||""),showHover:!!this.showHover},c=Rally.util.Ref.getRelativeUri(a),d=Rally.util.Ref.getTypeFromRef(c);if("testset"===d)c&&(b.onclick="Rally.nav.Manager.edit('"+c+"'); return false;");else if("milestone"===d){var e=a.TargetProject||a.context.getProject();b.projectOid=Rally.util.Ref.getOidFromRef(e)}return Rally.nav.DetailLink.getLink(b)},createIcon:function(a){if(this.showIcon===!1)return"";var b=Rally.util.Ref.getTypeFromRef(a),c=Rally.util.TypeInfo.normalizeTypeName(b),d=Rally.util.TypeInfo.getTypeInfoByName(c),e=d&&d.icon,f="milestone"===c&&a.DisplayColor?' style="color: '+a.DisplayColor+';"':"";return e?'<span class="artifact-icon '+e+'"'+f+"></span>":""},apply:function(a){var b=this._transformValues(a);return this.callParent([b])},_transformValues:function(a){var b=a[this.collectionName];return console.log("list",b),_.isArray(b)||(b=[]),b=Rally.util.Array.sortByAttribute(b,"FormattedID")}}),Ext.define("cats-milestone-by-release",{extend:"Rally.app.App",componentCls:"app",logger:new Rally.technicalservices.Logger,defaults:{margin:10},integrationHeaders:{name:"cats-milestone-by-release"},config:{defaultSettings:{groupByPortfolioLevel:1,query:null}},portfolioItemTypes:[],portfolioItemRecordsByType:{},launch:function(){return this.removeAll(),this.getContext().getTimeboxScope()&&"release"===this.getContext().getTimeboxScope().getType()?(this.milestoneHash,void this._fetchMilestones().then({success:function(a){this.logger.log("_fetchmilestones success",a),this.milestoneHash=_.reduce(a,function(a,b){return a["m"+b.get("ObjectID")]=b.getData(),a},{}),this.logger.log("milestoneHash",this.milestoneHash),this._fetchPortfolioItemTypes().then({success:this._initializeApp,failure:this._showAppError,scope:this})},failure:this._showAppError,scope:this})):void this._addAppMessage("This app is designed to run on a release scoped dashboard.")},_fetchMilestones:function(){var a=this.getAdditionalFilters()||[];return this.logger.log("_fetchMilestones",a.toString()),this._fetchWsapiRecords({model:"Milestone",fetch:["Name","FormattedID","ObjectID","TargetDate","DisplayColor"],filters:a,context:{project:null}})},getFeatureName:function(){return this.logger.log("getFeatureName",this.portfolioItemTypes[0]),this.portfolioItemTypes[0].replace("PortfolioItem/","")},_initializeApp:function(a){this.logger.log("_initializeApp",a),this.portfolioItemTypes=Ext.Array.map(a,function(a){return a.get("TypePath")}),this.onTimeboxScopeChange(this.getContext().getTimeboxScope())},_showAppError:function(a){this.add({xtype:"container",itemId:"errorMessage",html:Ext.String.format('<div class="no-data-container"><div class="primary-message">{0}</div></div>',a)})},_addAppMessage:function(a){this.add({xtype:"container",itemId:"appMessage",html:Ext.String.format('<div class="no-data-container"><div class="primary-message">{0}</div></div>',a)})},_clearWindow:function(){this.down("#appMessage")&&this.down("#appMessage").destroy(),this.down("rallygrid")&&this.down("rallygrid").destroy()},onTimeboxScopeChange:function(a){this.getContext().setTimeboxScope(a),this.logger.log("onTimeboxScopeChange",a,a.getRecord()),this._clearWindow(),a&&"release"===a.getType()?a.getRecord()?this._updateDisplay(a):this._addAppMessage("Please select a release to see portfolio milestones for that timebox."):this._addAppMessage("This app is designed to run on a dashboard with a Release timebox selector.")},getPortfolioGroupLevel:function(){return this.getSetting("groupByPortfolioLevel")},_buildStore:function(a){this.logger.log("_buildStore",a);var b=[],c=this.portfolioItemTypes[this.getPortfolioGroupLevel()].toLowerCase();Ext.Object.each(a[c],function(c,d){var e=d;e.Milestones=this._getMilestones(d,a),e.Features=this._getStories(d,a),e.Milestones.length>0&&b.push(e)},this),this.logger.log("_buildStore",b);var d=Ext.create("Rally.data.custom.Store",{data:b,fields:["FormattedID","Name","Milestones","Features","_ref","_type"],pageSize:b.length});this._addGrid(d)},_addGrid:function(a){this.down("rallygrid")&&this.down("rallygrid").destroy();var b=this.add({xtype:"rallygrid",store:a,columnCfgs:this._getColumnCfgs(),showRowActionsColumn:!1,showPagingToolbar:!1,height:this.getHeight()});this.logger.log("_addGrid",this.getHeight(),b.getHeight())},_getColumnCfgs:function(){return[{dataIndex:"FormattedID",text:"ID",renderer:function(a,b,c){return Ext.create("Rally.ui.renderer.template.FormattedIDTemplate").apply(c.data)}},{dataIndex:"Name",text:"Name",flex:1},{dataIndex:"Milestones",text:"Milestones",flex:1,renderer:function(a,b,c){return Ext.create("cats-milestone-by-release.utils.MilestonesTemplate",{collectionName:"Milestones",iconCls:"icon-milestone",cls:"milestone-pill"}).apply(c.getData())}},{dataIndex:"Features",text:"stories",flex:1,renderer:function(a,b,c){return Ext.create("cats-milestone-by-release.utils.PortfolioListTemplate",{collectionName:"Features",iconCls:"icon-portfolio"}).apply(c.getData())}}]},_getStories:function(a,b){var c=a._type&&a._type.toLowerCase(),d=b[c][a.ObjectID],e=(this.getContext().getTimeboxScope().getRecord().get("ReleaseStartDate"),this.getContext().getTimeboxScope().getRecord().get("ReleaseDate"),this._getPortfolioItemTypeOrdinal(c)),f=[d.ObjectID];if(this.logger.log("_getStories",a.FormattedID,e),e>0){e--;for(var g=e;g>=0;g--){portfolioType=this.portfolioItemTypes[g].toLowerCase();var h=[];Ext.Object.each(b[portfolioType],function(a,b){Ext.Array.contains(f,b.Parent&&b.Parent.ObjectID)&&h.push(b)}),f=_.pluck(h,"ObjectID")}}var h=[],i=this.getFeatureName();return Ext.Object.each(b.HierarchicalRequirement,function(a,b){Ext.Array.contains(f,b[i]&&b[i].ObjectID)&&h.push(b)}),this.logger.log("_getFeatures",f,h),h},_getFeatures:function(a,b){var c=a._type&&a._type.toLowerCase(),d=b[c][a.ObjectID],e=(this.getContext().getTimeboxScope().getRecord().get("ReleaseStartDate"),this.getContext().getTimeboxScope().getRecord().get("ReleaseDate"),this._getPortfolioItemTypeOrdinal(c)),f=[d.ObjectID];if(this.logger.log("_getFeatures",a.FormattedID,e),e>0){e--;for(var g=e;g>=0;g--){portfolioType=this.portfolioItemTypes[g].toLowerCase();var h=[];Ext.Object.each(b[portfolioType],function(a,b){Ext.Array.contains(f,b.Parent&&b.Parent.ObjectID)&&h.push(b)}),f=_.pluck(h,"ObjectID")}}return this.logger.log("_getFeatures",f,h),h},_getMilestones:function(a,b){var c=a._type&&a._type.toLowerCase(),d=b[c][a.ObjectID],e=this.getContext().getTimeboxScope().getRecord().get("ReleaseStartDate"),f=this.getContext().getTimeboxScope().getRecord().get("ReleaseDate");return this._pluckMilestones(d,e,f)},_pluckMilestones:function(a,b,c){var d=[],e=this.milestoneHash;return a&&a.Milestones&&a.Milestones._tagsNameArray&&a.Milestones._tagsNameArray.length>0&&Ext.Array.each(a.Milestones._tagsNameArray,function(a){var b="m"+Rally.util.Ref.getOidFromRef(a._ref);e[b]&&d.push(e[b])}),this.logger.log("_pluckMilestones",d),d},_getFeatureFilters:function(a,b){var c=this.getFeatureName(),d=[];Ext.Array.each(b,function(a){a.get(c)&&a.get(c).ObjectID&&d.push({property:"ObjectID",value:a.get(c).ObjectID})});return this.logger.log("_getFeatureFilters",d.length,b),d=d.length>1?Rally.data.wsapi.Filter.or(d):1===d.length?Ext.create("Rally.data.wsapi.Filter",d[0]):null,d&&a.getRecord()?d:Ext.create("Rally.data.wsapi.Filter",{property:"ObjectID",value:0})},_updateDisplay:function(a){this.logger.log("_updateDisplay",a.getQueryFilter());var b=a.getQueryFilter();this.portfolioItemRecordsByType={},this._fetchWsapiRecords({model:"HierarchicalRequirement",fetch:["FormattedID","ObjectID","Name",this.getFeatureName()],filters:b}).then({success:this._fetchFeatures,failure:this._showAppError,scope:this})},_fetchFeatures:function(a){this.logger.log("_fetchFeatures",a),this.portfolioItemRecordsByType.HierarchicalRequirement=_.map(a,function(a){return a.getData()});var b=[],c=this.getFeatureName();Ext.Array.each(a,function(a){a.get(c)&&a.get(c).ObjectID&&b.push({property:"ObjectID",value:a.get(c).ObjectID})}),b.length>1&&(b=Rally.data.wsapi.Filter.or(b)),this._fetchWsapiRecords({model:this.portfolioItemTypes[0],fetch:["FormattedID","ObjectID","Name","Milestones","Parent","TargetDate","FormattedID"],filters:b,enablePostGet:!0,context:{project:null}}).then({success:this._fetchAncestors,failure:this._showAppError,scope:this})},_getPortfolioItemTypeOrdinal:function(a){for(var b=0;b<this.portfolioItemTypes.length;b++)if(this.portfolioItemTypes[b].toLowerCase()===a.toLowerCase())return b;return b},getAdditionalFilters:function(){return this.getSetting("query")?Rally.data.wsapi.Filter.fromQueryString(this.getSetting("query")):null},_fetchAncestors:function(a){var b=this.portfolioItemTypes.length;a&&a.length>0&&(b=this._getPortfolioItemTypeOrdinal(a[0].get("_type")));var c=this._getUniqueParentOids(a);this.logger.log("_fetchAncestors",b,a,c),this.portfolioItemRecordsByType=_.reduce(a,function(a,b){return a[b.get("_type")]||(a[b.get("_type")]={}),a[b.get("_type")][b.get("ObjectID")]=b.getData(),a},this.portfolioItemRecordsByType);var d=Ext.Array.map(c,function(a){return{property:"ObjectID",value:a}});return b+1>=this.portfolioItemTypes.length||0===c.length?void this._buildStore(this.portfolioItemRecordsByType):(c.length>1&&(d=Rally.data.wsapi.Filter.or(d)),void this._fetchWsapiRecords({model:this.portfolioItemTypes[b+1],fetch:["FormattedID","ObjectID","Name","Milestones","Parent","TargetDate"],filters:d,context:{project:null},enablePostGet:!0}).then({success:this._fetchAncestors,failure:this._showAppError,scope:this}))},_getUniqueParentOids:function(a){this.logger.log("_getUniqueParentOids",a);for(var b=[],c=this.getFeatureName(),d=0;d<a.length;d++){a[d].get(c)||a[d].get("");a[d].get("Parent")&&b.push(a[d].get("Parent").ObjectID)}return Ext.Array.unique(b)},_fetchPortfolioItemTypes:function(){return this._fetchWsapiRecords({model:"TypeDefinition",fetch:["Name","TypePath","Ordinal"],filters:[{property:"TypePath",operator:"contains",value:"PortfolioItem/"}],sorters:[{property:"Ordinal",direction:"ASC"}]})},_fetchWsapiRecords:function(a){var b=Ext.create("Deft.Deferred"),c=this;return a.limit||(a.limit="Infinity"),a.pageSize||(a.pageSize=2e3),this.logger.log("Starting load:",a),Ext.create("Rally.data.wsapi.Store",a).load({callback:function(a,d,e){e?b.resolve(a):(c.logger.log("Failed: ",d),b.reject("Problem fetching: "+d.error.errors.join(". ")))}}),b.promise},getSettingsFields:function(){return[{xtype:"container",html:'<div class="no-data-container">Please enter a query for milestones below.</div>',padding:10},{type:"query"}]},getOptions:function(){return[{text:"About...",handler:this._launchInfo,scope:this}]},_launchInfo:function(){this.about_dialog&&this.about_dialog.destroy(),this.about_dialog=Ext.create("Rally.technicalservices.InfoLink",{})}});
            
               Rally.launchApp('cats-milestone-by-release', {
                   name: 'Milestones by Release'
               });
        });
    </script>
    
    <style type="text/css">

.app {
}
.tsinfolink {
    position:absolute;
    right:0px;
    width: 14px;
    height: 14px;
    border-radius: 7px;
    text-align: center;
    color: white;
    background: #C0C0C0;
    border-style: solid;
    border-width: 1px;
    margin-top: 25px;
    margin-right: 5px;
    cursor: pointer;
}

.appMessage {
  color: #222;
  font-family: ProximaNova, Helvetica, Arial;
  font-size: 18px;
  text-align: center;
}
.errorMessage {
  color: #B81B10;
  font-family: ProximaNova, Helvetica, Arial;
  font-size: 18px;
  text-align: center;
}

    </style>

</head>
<body></body>
</html>